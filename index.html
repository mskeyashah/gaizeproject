<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Source+Code+Pro" rel="stylesheet">
  <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">  
  <script src="https://d3js.org/d3.v3.min.js"></script>
</head>

<body>
    <section id="nbr" class="navbar">
        <div>
            <!-- <h1>GAIZE</h1> -->
            <img id="im" src="./logodark.png" />
        </div>
        <div class="dropdown">
            <a class="dropbtn" onclick="openTab(event, 'Train')">Train</a>
        </div>
        <div class="dropdown">
            <a class="dropbtn" onclick="openTab(event, 'Implementation')">Implementation</a>
        </div>
        <div class="dropdown">
            <a class="dropbtn" onclick="openTab(event, 'About')">About Us</a>
    </section>

   
    <div id="Train" class="tab">
        <div style="padding: 20px; text-align: justify;">
            <p id="ouput"></p>
            <li id="Accuracy"><a>Not yet Calibrated</a></li>
              <li style="padding: 20px; text-align: justify;"><a onclick="Restart()" href="#">Recalibrate</a></li>
            
          </div>
          <canvas id="plotting_canvas" width="500" height="400"></canvas>
         
            <div id="helpModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
            
                  <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-body">
                      <img src="calibration.png" width="100%" height="100%" alt="webgazer demo instructions"></img>
                    </div>
                    <div class="modal-footer">
                      <button id="closeBtn" type="button" class="btn btn-default" data-dismiss="modal">Close & load saved model </button>
                      <button type="button" id='start_calibration' class="btn btn-primary" data-dismiss="modal" onclick="Restart()">Calibrate</button>
                    </div>
                  </div>
            
                </div>
        </div>
    </div>
    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1"></input>
        <input type="button" class="Calibration" id="Pt2"></input>
        <input type="button" class="Calibration" id="Pt3"></input>
        <input type="button" class="Calibration" id="Pt4"></input>
        <input type="button" class="Calibration" id="Pt5"></input>
        <input type="button" class="Calibration" id="Pt6"></input>
        <input type="button" class="Calibration" id="Pt7"></input>
        <input type="button" class="Calibration" id="Pt8"></input>
        <input type="button" class="Calibration" id="Pt9"></input>
    </div>

    <div id="Implementation" class="tab" style="text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%); position: absolute;">
        <div id="drive">
            <iframe id="drive" width="840" height="472.5" src="https://www.youtube.com/embed/U_aDUFdPh7c" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <img id="text" style="position: absolute; display: none;" src="textnotif.jpg" height="400">
    </div>

    <div id="About" class="tab">
        <div class='controls'>

            <div style="padding: 20px; text-align: justify;">
                <!-- <h1 style="text-align: center;">GAIZE</h1> -->
                <div style="text-align: center;">
                    <img id="im" src="./gaizelogo.png" />
                </div>
                <p>We at Gaize are committed to help our users in variety of fields using eye tracking techniques. By using various machine learning algorithms we came up with a solution to increase the efficiency of our users in daily activities. Our software
                    can also be used in several other fields such as online examination, conducting research etc.</p>
                <p>Currently, our website showcases the use of our software by giving the users points based on the efficiency of their driving. Firstly, the user needs to train the software by visiting the Train tab and following the instructions there.
                    They can then check their driving efficiency in the Implementation tab.
                </p>
            </div>
        </div>
    </div>




   <!-- <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>-->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.5.0"></script> -->
    <!--<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>-->
    <!--<script src="clmtrackr.js"></script>
    <script src="app.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.8.1/localforage.js"></script>
  <script src="webgazer.js" type="text/javascript"></script>
  <script src="./node_modules/jquery/dist/jquery.min.js"></script>
  <script src="./node_modules/sweetalert/dist/sweetalert.min.js"></script>
  <script src="./js/main.js"></script>
  <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
</body>
<script>
    openTab(event, 'Train');
    navigator.mediaDevices.getUserMedia({audio: false, video: true})
  //webgazer.begin()
  //webgazer.setTracker("TFFacemesh");
  //webgazer.setRegression("ridge");
  //webgazer.showPredictionPoints(true)
  //webgazer.showVideoPreview(true)
  var xprediction;
  webgazer.setGazeListener(async function(data, elapsedTime) {
    if (data == null) {
        return;
    }
    
    xprediction = data.x; //these x coordinates are relative to the viewport
    var yprediction = data.y; //these y coordinates are relative to the viewport
    console.log(elapsedTime); //elapsed time is based on time since begin was called
})
PopUpInstruction();
    
  function resize() {
    var canvas = document.getElementById('plotting_canvas');
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
};
window.addEventListener('resize', resize, false);
  var PointCalibrate = 0;
var CalibrationPoints={};

/**
 * Clear the canvas and the calibration button.
 */
function ClearCanvas(){
  $(".Calibration").hide();
  var canvas = document.getElementById("plotting_canvas");
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}


var tag = document.createElement('script');

tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var player;

function onYouTubeIframeAPIReady() {
    player = new YT.Player('drive', {
        height: '472.5',
        width: '840',
        videoId: '8BdSzXQ6fCU',
        playerVars: {
            start: 441,
            controls: 0,
        },
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
        }
    });
}

var snd = new Audio("sound.mp3");

function show() {
    snd.play();
    $('#text').css('display', 'inline');
    setTimeout(hide, 5000); // 5 seconds
}

function hide() {
    $('#text').css('display', 'none');
}

function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
        var t = 0,
            f = 0;
        console.log('Playing')
        var r1 = Math.random() * 26
        var r2 = Math.random() * 26 + 30

        console.log(r1, r2)
        setTimeout(() => {
            show()
        }, r1 * 1000)
        setTimeout(() => {
            show()
        }, r2 * 1000)
        window.setInterval(function() {
            var d1_offset = $('#drive').offset();
            var d1_height = $('#drive').outerHeight(true);
            var d1_width = $('#drive').outerWidth(true);
            var d1_distance_from_top = d1_offset.top + d1_height;
            var d1_distance_from_left = d1_offset.left + d1_width;
            /*if(predi !== null) {
              //document.getElementById("Accuracy").innerHTML = predi.x;
                if(predi.y < 10)
                  $('#drive').css('border', '5px solid green');
                else
                $('#drive').css('border', '5px solid red');
            } else {
                $('#drive').css('border', '5px solid yellow');
            }*/
            // console.log(is_colliding($('#drive'), $('#target')));
            /*if (webgazer.is_colliding(d1_offset, d1_distance_from_top,d1_distance_from_left)) {
                $('#drive').css('border', '5px solid green');
                t++;
            } else {
                $('#drive').css('border', '5px solid red');
                f++;
            }*/
        }, 500);
        setTimeout(() => {
            window.clearInterval();
            var p = t / (t + f) * 100;
            $('#drive').css('border', 'none');
            stopVideo()
            alert(p + '%')
        }, 60000);
        // done = true;
    }
}
/**
 * Load this function when the index page starts.
* This function listens for button clicks on the html page
* checks that all buttons have been clicked 5 times each, and then goes on to measuring the precision
*/
$(document).ready(function(){
  //ClearCanvas();
  //helpModalShow();
  ShowCalibrationPoint();
     $(".Calibration").click(function(){ // click event on the calibration buttons

      var id = $(this).attr('id');

      if (!CalibrationPoints[id]){ // initialises if not done
        CalibrationPoints[id]=0;
      }
      CalibrationPoints[id]++; // increments values

      if (CalibrationPoints[id]==5){ //only turn to yellow after 5 clicks
        $(this).css('background-color','yellow');
        $(this).prop('disabled', true); //disables the button
        PointCalibrate++;
      }else if (CalibrationPoints[id]<5){
        //Gradually increase the opacity of calibration points when click to give some indication to user.
        var opacity = 0.2*CalibrationPoints[id]+0.2;
        $(this).css('opacity',opacity);
      }

      //Show the middle calibration point after all other points have been clicked.
      if (PointCalibrate == 8){
        $("#Pt5").show();
      }
      
      if (PointCalibrate >= 9){ // last point is calibrated
            //using jquery to grab every element in Calibration class and hide them except the middle point.
            $(".Calibration").hide();
            $("#Pt5").show();

            // clears the canvas
            var canvas = document.getElementById("plotting_canvas");
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            
            // notification for the measurement process
            swal({
              title: "Calculating measurement",
              text: "Please don't move your mouse & stare at the middle dot for the next 5 seconds. This will allow us to calculate the accuracy of our predictions.",
              closeOnEsc: false,
              allowOutsideClick: false,
              closeModal: true
            }).then( isConfirm => {

                // makes the variables true for 5 seconds & plots the points
                $(document).ready(function(){

                  store_points_variable(); // start storing the prediction points

                  sleep(5000).then(() => {
                      stop_storing_points_variable(); // stop storing the prediction points
                      var past50 = webgazer.getStoredPoints(); // retrieve the stored points
                      var precision_measurement = calculatePrecision(past50);
                      var accuracyLabel = "<a>Accuracy | "+precision_measurement+"%</a>";
                      document.getElementById("Accuracy").innerHTML = accuracyLabel; // Show the accuracy in the nav bar.
                      swal({
                        title: "Your accuracy measure is "+precision_measurement + "%",
                        allowOutsideClick: false,
                        buttons: {
                          cancel: "Recalibrate",
                          confirm: true,
                        }
                      }).then(isConfirm => {
                          if (isConfirm){
                            //clear the calibration & hide the last middle button
                            ClearCanvas();
                          } else {
                            //use restart function to restart the calibration
                            document.getElementById("Accuracy").innerHTML = "<a>Not yet Calibrated</a>";
                            webgazer.clearData();
                            ClearCalibration();
                            ClearCanvas();
                            ShowCalibrationPoint();
                          }
                      });
                  });
                });
            });
          }
    });
});

</script>
</html>